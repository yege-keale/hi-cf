name: Auto Sync Upstream

on:
  schedule:
    - cron: "0 */12 * * *"   # æ¯ 12 å°æ—¶åŒæ­¥ä¸€æ¬¡
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set upstream repo manually
        run: |
          # åœ¨æ­¤å¡«å†™çœŸå®ä¸Šæ¸¸ä»“åº“ï¼Œä¾‹å¦‚ï¼š
          # UPSTREAM_REPO="shaoyouvip/uptime"
          # UPSTREAM_REPO="cmliu/WorkerVless2sub"

          UPSTREAM_REPO="eooce/Cloudflare-proxy"

          echo "upstream_repo=$UPSTREAM_REPO" >> $GITHUB_OUTPUT

      - name: Sync main branch
        run: |
          set -e

          UPSTREAM_REPO="${{ steps.set-upstream-repo.outputs.upstream_repo }}"

          echo "ä½¿ç”¨çš„ä¸Šæ¸¸ä»“åº“ï¼š$UPSTREAM_REPO"

          git remote add upstream "https://github.com/$UPSTREAM_REPO.git" || true
          git remote set-url upstream "https://github.com/$UPSTREAM_REPO.git"

          git fetch upstream main

          LOCAL=$(git rev-parse origin/main)
          REMOTE=$(git rev-parse upstream/main)

          if [ "$LOCAL" = "$REMOTE" ]; then
            echo "ğŸ’¤ ä¸Šæ¸¸æ— æ›´æ–°ï¼Œè·³è¿‡åŒæ­¥"
            exit 0
          fi

          echo "ğŸ”„ æ£€æµ‹åˆ°æ›´æ–°ï¼Œå¼€å§‹åŒæ­¥..."
          git checkout main
          git merge upstream/main --no-edit
          git push origin main
          echo "âœ… åŒæ­¥å®Œæˆ"
