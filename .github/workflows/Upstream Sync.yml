name: Auto Sync Upstream

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *" # 每天自动运行

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
    # -------------------------
    # 1. 拉取当前仓库代码
    # -------------------------
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # -------------------------
    # 2. 检测 upstream 仓库是否存在
    # -------------------------
    - name: Detect Upstream
      id: detect
      run: |
        set -e
        echo "检查 upstream 是否存在..."

        if ! git remote | grep -q upstream; then
          echo "未找到 upstream，自动添加。"
          # 自动获取上游仓库 URL
          UP_URL="$(git config --get remote.origin.url | sed 's/\.git$//')"
          UP_URL="${UP_URL%/*}"
          UPSTREAM="${UP_URL##*/}"

          echo "推测上游仓库为：$UPSTREAM"

          # 自动添加 upstream
          git remote add upstream "https://github.com/$UPSTREAM/$(basename "$UP_URL").git"
        fi

        echo "upstream 已准备就绪。"

    # -------------------------
    # 3. 检测当前分支名称（支持 main/master）
    # -------------------------
    - name: Detect Branch
      id: branch
      run: |
        BRANCH="$(git symbolic-ref --short HEAD || echo main)"
        echo "当前分支是：$BRANCH"
        echo "branch=$BRANCH" >> $GITHUB_OUTPUT

    # -------------------------
    # 4. 获取 upstream 最新提交
    # -------------------------
    - name: Fetch Upstream
      run: |
        set -e
        BRANCH="${{ steps.branch.outputs.branch }}"
        echo "从 upstream 获取 $BRANCH 最新提交..."

        git fetch upstream "$BRANCH"

    # -------------------------
    # 5. 判断是否有更新
    # -------------------------
    - name: Check Diff
      id: diff
      run: |
        set -e
        BRANCH="${{ steps.branch.outputs.branch }}"
        LOCAL=$(git rev-parse "origin/$BRANCH")
        REMOTE=$(git rev-parse "upstream/$BRANCH")

        echo "本地提交：$LOCAL"
        echo "上游提交：$REMOTE"

        if [ "$LOCAL" = "$REMOTE" ]; then
          echo "no_update=true" >> $GITHUB_OUTPUT
          echo "没有更新，跳过同步。"
        else
          echo "no_update=false" >> $GITHUB_OUTPUT
          echo "检测到更新，准备同步..."
        fi

    # -------------------------
    # 6. 同步最新更新（只有上游有更新才执行）
    # -------------------------
    - name: Merge & Push
      if: steps.diff.outputs.no_update == 'false'
      run: |
        set -e
        BRANCH="${{ steps.branch.outputs.branch }}"

        echo "开始合并 upstream/$BRANCH..."
        git checkout "$BRANCH"
        git merge "upstream/$BRANCH" --no-edit

        echo "推送到 origin..."
        git push origin "$BRANCH"

        echo "同步完成 ✔️"
