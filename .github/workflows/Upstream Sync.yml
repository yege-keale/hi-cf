name: Auto Sync Upstream
on:
  schedule:
    - cron: "0 */12 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect upstream from origin
        id: upstream
        run: |
          set -e

          ORIGIN_URL=$(git remote get-url origin)

          echo "Fork çš„ origin URL:"
          echo "$ORIGIN_URL"

          # ä» origin URL å»æ‰ç”¨æˆ·åï¼Œä¿ç•™ä»“åº“å
          # ä¾‹å¦‚ï¼š https://github.com/YourName/Repo.git â†’ Repo.git
          REPO_NAME=$(basename "$ORIGIN_URL")

          # å»æ‰ .git
          REPO_NAME="${REPO_NAME%.git}"

          # è·å–è¿œç¨‹ä»“åº“çš„çœŸå®çˆ¶ä»“åº“ï¼ˆAPI æŸ¥è¯¢ï¼‰
          PARENT=$(curl -s "https://api.github.com/repos/$GITHUB_REPOSITORY" | jq -r '.parent.full_name')

          if [ "$PARENT" = "null" ] || [ -z "$PARENT" ]; then
            echo "âŒ GitHub API æ— æ³•è·å– parentï¼Œè¯´æ˜ fork æ¥æºå·²åˆ é™¤/è¿ç§»"
            echo "âŒ æ— æ³•ç»§ç»­è‡ªåŠ¨åŒæ­¥"
            exit 1
          fi

          echo "ä¸Šæ¸¸ä»“åº“ï¼š$PARENT"

          echo "parent=$PARENT" >> $GITHUB_OUTPUT

          git remote add upstream "https://github.com/$PARENT.git" || true
          git remote set-url upstream "https://github.com/$PARENT.git"

      - name: Sync branch
        run: |
          set -e

          UPSTREAM="${{ steps.upstream.outputs.parent }}"

          echo "ä»ä¸Šæ¸¸è·å–æœ€æ–°å†…å®¹ï¼š$UPSTREAM"

          git fetch upstream main

          LOCAL=$(git rev-parse origin/main)
          REMOTE=$(git rev-parse upstream/main)

          if [ "$LOCAL" = "$REMOTE" ]; then
            echo "ğŸ’¤ æ²¡æœ‰æ–°æäº¤ï¼Œè·³è¿‡åŒæ­¥ã€‚"
            exit 0
          fi

          echo "ğŸ”„ æ£€æµ‹åˆ°æ›´æ–°ï¼Œå¼€å§‹åŒæ­¥..."
          git checkout main
          git merge upstream/main --no-edit

          git push origin main
          echo "âœ… åŒæ­¥å®Œæˆï¼"
